<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>ç”¨æˆ·é¦–é¡µ - èµ„äº§ç®¡ç†ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- ä½¿ç”¨ CDN çš„ UMD ç‰ˆæœ¬ä½œä¸ºä¸´æ—¶è§£å†³æ–¹æ¡ˆ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        .sidebar {
            background-color: #f8f9fa;
            min-height: calc(100vh - 56px);
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        }

        .nav-link {
            color: #495057;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            margin-bottom: 0.25rem;
        }

        .nav-link:hover,
        .nav-link.active {
            background-color: #e9ecef;
            color: #0d6efd;
        }

        .stat-card {
            border-left: 4px solid #0d6efd;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .chart-container {
            background: white;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            min-height: 300px;
        }

        .chart-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 250px;
            color: #6c757d;
        }
    </style>
</head>

<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">èµ„äº§ç®¡ç†ç³»ç»Ÿ - ç”¨æˆ·ä¸­å¿ƒ</span>
            <div>
                <span class="text-light me-3">æ¬¢è¿, {{ user.username }}</span>
                {% if user.user_type == 'admin' %}
                <a href="/admin" class="btn btn-light me-2">ç®¡ç†åå°</a>
                {% endif %}
                <a href="/logout" class="btn btn-outline-light">é€€å‡º</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- ä¾§è¾¹æ èœå• -->
            <div class="col-md-3 col-lg-2 sidebar">
                <nav class="nav flex-column p-3">
                    <a class="nav-link active" href="/user_dashboard">
                        ğŸ“Š Dashboard
                    </a>
                    <a class="nav-link" href="/user_profile">
                        ğŸ‘¤ ä¸ªäººä¿¡æ¯
                    </a>

                    <!-- é¡¹ç›®èœå• -->
                    <a class="nav-link" data-bs-toggle="collapse" href="#projectsMenu">
                        ğŸ“ é¡¹ç›®
                    </a>
                    <div class="collapse show" id="projectsMenu">
                        <div class="submenu">
                            <a class="nav-link" href="/user_projects?type=participated">æˆ‘å‚ä¸çš„</a>
                            <a class="nav-link" href="/user_projects?type=created">æˆ‘åˆ›å»ºçš„</a>
                            <a class="nav-link" href="/user_projects?type=responsible">æˆ‘è´Ÿè´£çš„</a>
                        </div>
                    </div>

                    <!-- æŠ¥å‘Šèœå• -->
                    <a class="nav-link" data-bs-toggle="collapse" href="#reportsMenu">
                        ğŸ“„ æŠ¥å‘Š
                    </a>
                    <div class="collapse show" id="reportsMenu">
                        <div class="submenu">
                            <a class="nav-link" href="/user_reports?type=created">æˆ‘åˆ›å»ºçš„</a>
                            <a class="nav-link" href="/user_reports?type=reviewed">æˆ‘å¤æ ¸çš„</a>
                            <a class="nav-link" href="/user_reports?type=signed">æˆ‘ç­¾å­—çš„</a>
                        </div>
                    </div>
                </nav>
            </div>

            <!-- ä¸»å†…å®¹åŒº -->
            <div class="col-md-9 col-lg-10 p-4">
                <h3 class="mb-4">Dashboard</h3>

                <!-- ç»Ÿè®¡å¡ç‰‡ -->
                <div class="row mb-4">
                    <!-- é¡¹ç›®ç»Ÿè®¡ -->
                    <div class="col-md-6 mb-3">
                        <div class="card stat-card h-100">
                            <div class="card-body">
                                <h5 class="card-title">é¡¹ç›®ç»Ÿè®¡</h5>
                                <div class="row">
                                    <div class="col-6">
                                        <h6>è´Ÿè´£çš„é¡¹ç›®</h6>
                                        <p class="mb-1">è¿›è¡Œä¸­: {{ dashboard_data.responsible_projects.get('active', 0) }}
                                        </p>
                                        <p>å·²å®Œæˆ: {{ dashboard_data.responsible_projects.get('completed', 0) }}</p>
                                    </div>
                                    <div class="col-6">
                                        <h6>å‚ä¸çš„é¡¹ç›®</h6>
                                        <p class="mb-1">è¿›è¡Œä¸­: {{ dashboard_data.participated_projects.get('active', 0) }}
                                        </p>
                                        <p>å·²å®Œæˆ: {{ dashboard_data.participated_projects.get('completed', 0) }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æŠ¥å‘Šç»Ÿè®¡ -->
                    <div class="col-md-6 mb-3">
                        <div class="card stat-card h-100">
                            <div class="card-body">
                                <h5 class="card-title">æŠ¥å‘Šç»Ÿè®¡</h5>
                                <div class="row text-center">
                                    <div class="col-4">
                                        <h3 class="text-primary">{{ dashboard_data.created_reports }}</h3>
                                        <small>åˆ›å»ºçš„æŠ¥å‘Š</small>
                                    </div>
                                    <div class="col-4">
                                        <h3 class="text-success">{{ dashboard_data.reviewed_reports }}</h3>
                                        <small>å¤æ ¸çš„æŠ¥å‘Š</small>
                                    </div>
                                    <div class="col-4">
                                        <h3 class="text-warning">{{ dashboard_data.signed_reports }}</h3>
                                        <small>ç­¾å­—çš„æŠ¥å‘Š</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å›¾è¡¨åŒºåŸŸ -->
                <div class="row">
                    <!-- æœˆåº¦æŠ¥å‘Šç»Ÿè®¡ -->
                    <div class="col-md-6">
                        <div class="chart-container">
                            <h5>è¿‘ä¸€å¹´æœˆåº¦æŠ¥å‘Šå‚ä¸æ•°</h5>
                            <div class="chart-placeholder" id="monthlyReportsPlaceholder">
                                åŠ è½½å›¾è¡¨ä¸­...
                            </div>
                            <canvas id="monthlyReportsChart" style="display: none;"></canvas>
                        </div>
                    </div>

                    <!-- æœˆåº¦é¡¹ç›®ç»Ÿè®¡ -->
                    <div class="col-md-6">
                        <div class="chart-container">
                            <h5>è¿‘ä¸€å¹´æœˆåº¦é¡¹ç›®å‚ä¸æ•°</h5>
                            <div class="chart-placeholder" id="monthlyProjectsPlaceholder">
                                åŠ è½½å›¾è¡¨ä¸­...
                            </div>
                            <canvas id="monthlyProjectsChart" style="display: none;"></canvas>
                        </div>
                    </div>

                    <!-- ç­¾å­—æŠ¥å‘Šç±»å‹åˆ†å¸ƒ -->
                    <div class="col-md-6">
                        <div class="chart-container">
                            <h5>ç­¾å­—æŠ¥å‘Šç±»å‹åˆ†å¸ƒ</h5>
                            <div class="chart-placeholder" id="signedReportsPlaceholder">
                                åŠ è½½å›¾è¡¨ä¸­...
                            </div>
                            <canvas id="signedReportsChart" style="display: none;"></canvas>
                        </div>
                    </div>

                    <!-- å¤æ ¸æŠ¥å‘Šç±»å‹åˆ†å¸ƒ -->
                    <div class="col-md-6">
                        <div class="chart-container">
                            <h5>å¤æ ¸æŠ¥å‘Šç±»å‹åˆ†å¸ƒ</h5>
                            <div class="chart-placeholder" id="reviewedReportsPlaceholder">
                                åŠ è½½å›¾è¡¨ä¸­...
                            </div>
                            <canvas id="reviewedReportsChart" style="display: none;"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // æ•°æ®å¯¹è±¡
//         const chartData = {
//             monthly_reports: {{ dashboard_data.monthly_reports | tojson }},
//         monthly_projects: { { dashboard_data.monthly_projects | tojson } },
//         signed_report_types: { { dashboard_data.signed_report_types | tojson } },
//         reviewed_report_types: { { dashboard_data.reviewed_report_types | tojson } }
// };
        const chartData = {
    monthly_reports: { "2025-01": 1, "2025-03": 1, "2025-07": 1, "2025-11": 4 },
    monthly_projects: {"2025-01": 1, "2025-02": 1, "2025-06": 1},
    signed_report_types: {"ç±»å‹A": 3, "ç±»å‹B": 2, "ç±»å‹C": 1},  // æµ‹è¯•æ•°æ®
    reviewed_report_types: {"ç±»å‹A": 5, "ç±»å‹B": 3, "ç±»å‹C": 2}  // æµ‹è¯•æ•°æ®
};
        console.log('ğŸ“Š å›¾è¡¨æ•°æ®:', chartData);

        // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', function () {
            console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ–å›¾è¡¨...');

            // æ£€æŸ¥ Chart.js æ˜¯å¦åŠ è½½æˆåŠŸ
            if (typeof Chart === 'undefined') {
                console.error('âŒ Chart.js æœªåŠ è½½');
                showAllChartErrors('å›¾è¡¨åº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                return;
            }

            console.log('âœ… Chart.js åŠ è½½æˆåŠŸï¼Œç‰ˆæœ¬:', Chart.version);
            initializeAllCharts();
        });

        function showAllChartErrors(message) {
            const placeholders = document.querySelectorAll('.chart-placeholder');
            placeholders.forEach(placeholder => {
                placeholder.innerHTML = `<div class="alert alert-warning">${message}</div>`;
            });
        }

        function initializeAllCharts() {
            console.log('ğŸ¨ å¼€å§‹æ¸²æŸ“å›¾è¡¨...');

            // åˆå§‹åŒ–æ‰€æœ‰å›¾è¡¨ï¼Œä½¿ç”¨æ­£ç¡®çš„å ä½ç¬¦ID
            if (chartData.monthly_reports && Object.keys(chartData.monthly_reports).length > 0) {
                initChart('monthlyReportsChart', 'monthlyReportsPlaceholder', 'bar',
                    Object.keys(chartData.monthly_reports),
                    Object.values(chartData.monthly_reports),
                    'æŠ¥å‘Šæ•°', 'rgba(54, 162, 235, 0.5)');
            } else {
                const placeholder = document.getElementById('monthlyReportsPlaceholder');
                if (placeholder) placeholder.innerHTML = '<div class="alert alert-info">æš‚æ— æœˆåº¦æŠ¥å‘Šæ•°æ®</div>';
            }

            if (chartData.monthly_projects && Object.keys(chartData.monthly_projects).length > 0) {
                initChart('monthlyProjectsChart', 'monthlyProjectsPlaceholder', 'bar',
                    Object.keys(chartData.monthly_projects),
                    Object.values(chartData.monthly_projects),
                    'é¡¹ç›®æ•°', 'rgba(75, 192, 192, 0.5)');
            } else {
                const placeholder = document.getElementById('monthlyProjectsPlaceholder');
                if (placeholder) placeholder.innerHTML = '<div class="alert alert-info">æš‚æ— æœˆåº¦é¡¹ç›®æ•°æ®</div>';
            }

            if (chartData.signed_report_types && Object.keys(chartData.signed_report_types).length > 0) {
                initChart('signedReportsChart', 'signedReportsPlaceholder', 'pie',
                    Object.keys(chartData.signed_report_types),
                    Object.values(chartData.signed_report_types),
                    '', '', true);
            } else {
                const placeholder = document.getElementById('signedReportsPlaceholder');
                if (placeholder) placeholder.innerHTML = '<div class="alert alert-info">æš‚æ— ç­¾å­—æŠ¥å‘Šç±»å‹æ•°æ®</div>';
            }

            if (chartData.reviewed_report_types && Object.keys(chartData.reviewed_report_types).length > 0) {
                initChart('reviewedReportsChart', 'reviewedReportsPlaceholder', 'pie',
                    Object.keys(chartData.reviewed_report_types),
                    Object.values(chartData.reviewed_report_types),
                    '', '', true);
            } else {
                const placeholder = document.getElementById('reviewedReportsPlaceholder');
                if (placeholder) placeholder.innerHTML = '<div class="alert alert-info">æš‚æ— å¤æ ¸æŠ¥å‘Šç±»å‹æ•°æ®</div>';
            }

            console.log('ğŸ‰ æ‰€æœ‰å›¾è¡¨åˆå§‹åŒ–å®Œæˆ');
        }

        function initChart(canvasId, placeholderId, type, labels, data, label, color, isPie = false) {
            const canvas = document.getElementById(canvasId);
            const placeholder = document.getElementById(placeholderId);

            if (!canvas) {
                console.error('æœªæ‰¾åˆ°ç”»å¸ƒ:', canvasId);
                if (placeholder) {
                    placeholder.innerHTML = '<div class="alert alert-danger">å›¾è¡¨å®¹å™¨æœªæ‰¾åˆ°</div>';
                }
                return;
            }

            if (!placeholder) {
                console.error('æœªæ‰¾åˆ°å ä½ç¬¦:', placeholderId);
                return;
            }

            // æ£€æŸ¥æ•°æ®æ˜¯å¦ä¸ºç©º
            if (!data || data.length === 0 || data.every(val => val === 0)) {
                placeholder.innerHTML = '<div class="alert alert-info">æš‚æ— æ•°æ®</div>';
                return;
            }

            try {
                const config = isPie ? {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'right'
                            }
                        }
                    }
                } : {
                    type: type,
                    data: {
                        labels: labels,
                        datasets: [{
                            label: label,
                            data: data,
                            backgroundColor: color,
                            borderColor: color.replace('0.5', '1'),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                };

                new Chart(canvas, config);

                // æ˜¾ç¤ºç”»å¸ƒï¼Œéšè—å ä½ç¬¦
                canvas.style.display = 'block';
                placeholder.style.display = 'none';

                console.log('âœ… å›¾è¡¨åˆå§‹åŒ–æˆåŠŸ:', canvasId);
            } catch (error) {
                console.error('å›¾è¡¨åˆå§‹åŒ–å¤±è´¥:', canvasId, error);
                placeholder.innerHTML = '<div class="alert alert-danger">å›¾è¡¨æ¸²æŸ“å¤±è´¥: ' + error.message + '</div>';
            }
        }
    </script>
</body>

</html>